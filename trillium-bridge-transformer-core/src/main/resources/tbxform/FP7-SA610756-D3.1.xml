<?xml version="1.0" encoding="UTF-8"?>
<map xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://trilliumbridge.org/xform ../schema/TBXform.xsd"
    xmlns="http://trilliumbridge.org/xform">

    <entry from="epSOS" to="CCD" invertable="true">
        <documentation>The stylesheet needs to be mapped from the appropriate type and langauge</documentation>
        <frompath>processing-instruction/xml-stylesheet</frompath>
        <topath>processing-instruction/xml-stylesheet</topath>
        <transformation name="setStyleSheet">
            <entry value="{to}-{language}" default="{to}"/>
        </transformation>
    </entry>

    <entry from="epSOS" to="CCD" invertable="true" globals="true">
        <frompath>/</frompath>
        <entry invertable="true">
            <documentation>All titles get location independent transformation</documentation>
            <frompath>title</frompath>
            <topath>title</topath>
            <transformation name="translateTitle"/>
        </entry>
    </entry>



    <entry from="epSOS" to="CCD" invertable="true">
        <documentation>Entry point for the epSOS to CCD transformation (and visa-versa)</documentation>
        <frompath>/ClinicalDocument[templateId/@root="1.3.6.1.4.1.12559.11.10.1.3.1.1.3"]</frompath>
        <topath>/ClinicalDocument[templateId/@root="2.16.840.1.113883.10.20.22.1.2"]</topath>
        <entry invertable="true">
            <documentation>The root template identifier needs to be changed from epSOS to CCD</documentation>
            <frompath>/templateId</frompath>
            <topath>/templateId</topath>
            <transformation name="changeTemplateRoots">
                <entry fromid="1.3.6.1.4.1.12559.11.10.1.3.1.1.3"/>
                <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.1.1"/>
                <entry toid="2.16.840.1.113883.10.20.22.1.2"/>
                <entry toid="2.16.840.1.113883.10.20.22.1.1"/>
            </transformation>
        </entry>
        <entry invertable="true">
            <documentation>All documents need a new identifier </documentation>
            <frompath>/id</frompath>
            <topath>/id</topath>
            <transformation name="newid"/>
        </entry>
        <entry invertable="true">
            <documentation>Translate the identifying code</documentation>
            <frompath>/code</frompath>
            <topath>/code</topath>
            <transformation name="mapValueSet" map="CCDtoEPSOSHeader"/>
        </entry>
        <entry invertable="true">
            <documentation>Translate the language</documentation>
            <frompath>/languageCode</frompath>
            <topath>/languageCode</topath>
            <transformation name="mapLanguage"/>
        </entry>
        <entry invertable="true">
            <frompath>/component/structuredBody</frompath>
            <topath>/component/structuredBody</topath>
            <!-- ======================= allergies-adverse-reactions-alerts ======================== -->
            <entry invertable="true">
                <frompath>/component/section[templateId/@root="2.16.840.1.113883.10.20.1.2"]</frompath>
                <topath>/component/section[templateId/@root="2.16.840.1.113883.10.20.22.2.6.1"]</topath>
                <entry invertable="true">
                    <frompath>/templateId</frompath>
                    <topath>/templateId</topath>
                    <transformation name="changeTemplateRoots">
                        <entry fromid="2.16.840.1.113883.10.20.1.2"/>
                        <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.3.13"/>
                        <entry toid="2.16.840.1.113883.10.20.22.2.6"/>
                        <entry toid="2.16.840.1.113883.10.20.22.2.6.1"/>
                    </transformation>
                </entry>
                <entry invertable="true">
                    <frompath>/text</frompath>
                    <topath>/text</topath>
                    <transformation name="translateText"/>
                </entry>
                <entry invertable="true">
                    <frompath>/entry[@typeCode="DRIV"]/act[templateId/@root="2.16.840.1.113883.10.20.1.27"]</frompath>
                    <topath>/entry[@typeCode="DRIV"]/act[templateId/@root="2.16.840.1.113883.10.20.22.2.6"]</topath>
                    <entry invertable="true">
                        <frompath>/templateId</frompath>
                        <topath>/templateId</topath>
                        <transformation name="changeTemplateRoots">
                            <entry fromid="2.16.840.1.113883.10.20.1.27"/>
                            <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.4.5.1"/>
                            <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.4.5.3"/>
                            <entry toid="2.16.840.1.113883.10.20.22.4.30"/>
                        </transformation>
                    </entry>
                    <entry invertable="true">
                        <frompath>/code</frompath>
                        <topath>/code</topath>
                        <transformation name="replaceCode">
                            <entry>
                                <fromcode>
                                    <code nullFlavor="NA" xmlns="urn:hl7-org:v3"/>
                                </fromcode>
                                <tocode>
                                    <code code="48765-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                                        displayName="Allergies, adverse reactions, alerts" xmlns="urn:hl7-org:v3"/>
                                </tocode>
                            </entry>
                        </transformation>
                    </entry>
                    <entry invertable="true">
                        <frompath>/entryRelationship[@typeCode="SUBJ"]/observation[templateId/@root="2.16.840.1.113883.10.20.1.18"]</frompath>
                        <topath>/entryRelationship[@typeCode="SUBJ"]/observation[templateId/@root="2.16.840.1.113883.10.20.22.4.7"]</topath>
                        <entry invertable="true">
                            <frompath>/templateId</frompath>
                            <topath>/templateId</topath>
                            <transformation name="changeTemplateRoots">
                                <entry fromid="2.16.840.1.113883.10.20.1.18"/>
                                <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.4.6"/>
                                <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.4.5"/>
                                <entry fromid="2.16.840.1.113883.10.20.1.28"/>
                                <entry toid="2.16.840.1.113883.10.20.22.4.7"/>
                            </transformation>
                        </entry>
                        <entry invertable="true">
                            <documentation>Add an assertion code in the CCD direction and remove it in the epSOS</documentation>
                            <frompath>/code</frompath>
                            <topath>/code</topath>
                            <transformation name="replaceCode">
                                <entry>
                                    <tocode>
                                        <code code="ASSERTION" codeSystem="2.16.840.1.113883.5.4" xmlns="urn:hl7-org:v3"/>
                                    </tocode>
                                </entry>
                            </transformation>
                        </entry>
                        <entry invertable="true">
                            <frompath>/value</frompath>
                            <topath>/value</topath>
                            <transformation name="replaceValue">
                                <entry>
                                    <fromValue>
                                        <value xsi:type="CD" xmlns="urn:hl7-org:v3">
                                            <originalText>
                                                <reference value="#allergy.1"/>
                                            </originalText>
                                        </value>
                                    </fromValue>
                                    <toValue>
                                        <value xsi:type="CD" code="416098002" displayName="Drug allergy" codeSystem="2.16.840.1.113883.6.96"
                                            codeSystemName="SNOMED CT" xmlns="urn:hl7-org:v3"/>
                                    </toValue>
                                </entry>
                            </transformation>
                        </entry>
                        <entry invertable="true">
                            <frompath>/participant[@typeCode="CSM"]/participantRole[@classCode="MANU"]/playingEntity[@classCode="MMAT"]/code</frompath>
                            <topath>/participant[@typeCode="CSM"]/participantRole[@classCode="MANU"]/playingEntity[@classCode="MMAT"]/code</topath>
                            <transformation name="mapValueSet" map="ATC_NDF-RT_epSOSActiveIngredient_VS"/>
                        </entry>
                        <entry invertable="true">
                            <documentation>Remove the entryRelationship template code completely</documentation>
                            <frompath>/entryRelationship[templateId/@root="1.3.6.1.4.1.19376.1.5.3.1.4.6.1"]</frompath>
                            <entry invertable="false">
                                <frompath>/templateId</frompath>
                                <transformation name="changeTemplateRoots">
                                    <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.4.6.1"/>
                                </transformation>
                            </entry>
                            <entry invertable="true">
                                <frompath>/observation[templateId/@root="2.16.840.1.113883.10.20.1.54"]</frompath>
                                <topath>/observation[templateId/@root="2.16.840.1.113883.10.20.22.4.9"]</topath>
                                <entry invertable="true">
                                    <frompath>/templateId</frompath>
                                    <topath>/templateId</topath>
                                    <transformation name="changeTemplateRoots">
                                        <entry fromid="2.16.840.1.113883.10.20.1.54"/>
                                        <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.4.5"/>
                                        <entry fromid="2.16.840.1.113883.10.20.1.28"/>
                                        <entry toid="2.16.840.1.113883.10.20.22.4.9"/>
                                    </transformation>
                                </entry>
                            </entry>
                        </entry>
                    </entry>
                </entry>
            </entry>
            <!-- ======================= Problem List ============================================== -->
            <entry invertable="true">
                <frompath>/component/section[templateId/@root="2.16.840.1.113883.10.20.1.11"]</frompath>
                <topath>/component/section[templateId/@root="2.16.840.1.113883.10.20.22.2.5"]</topath>
                <entry invertable="true">
                    <frompath>/templateId</frompath>
                    <topath>/templateId</topath>
                    <transformation name="changeTemplateRoots">
                        <entry fromid="2.16.840.1.113883.10.20.1.11"/>
                        <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.3.6"/>
                        <entry toid="2.16.840.1.113883.10.20.22.2.5"/>
                        <entry toid="2.16.840.1.113883.10.20.22.2.5.1"/>
                    </transformation>
                </entry>
                <entry invertable="false">
                    <frompath>/text</frompath>
                    <topath>/text</topath>
                    <transformation name="translateText"/>
                </entry>
                <entry invertable="true">
                    <frompath>/entry[@typeCode="DRIV"]/act[templateId/@root="2.16.840.1.113883.10.20.1.27"]</frompath>
                    <topath>/entry[@typeCode="DRIV"]/act[templateId/@root="2.16.840.1.113883.10.20.22.4.3"]</topath>
                    <entry invertable="true">
                        <frompath>/templateId</frompath>
                        <topath>/templateId</topath>
                        <transformation name="changeTemplateRoots">
                            <entry fromid="2.16.840.1.113883.10.20.1.27"/>
                            <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.4.5.1"/>
                            <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.4.5.2"/>
                            <entry toid="2.16.840.1.113883.10.20.22.4.3"/>
                        </transformation>

                    </entry>
                    <entry invertable="true">
                        <frompath>/code</frompath>
                        <topath>/code</topath>
                        <transformation name="replaceCode">
                            <entry>
                                <fromcode>
                                    <code nullFlavor="NA" xmlns="urn:hl7-org:v3"/>
                                </fromcode>
                                <tocode>
                                    <code code="CONC" codeSystem="2.16.840.1.113883.5.6" displayName="Concern" xmlns="urn:hl7-org:v3"/>
                                </tocode>
                            </entry>
                        </transformation>
                    </entry>
                    <entry invertable="true">
                        <frompath>/value</frompath>
                        <topath>/value</topath>
                        <transformation name="mapValueSet" map="ICD_10_SNOMED_CT_epSOSIllnesses_VS"/>
                    </entry>
                </entry>
            </entry>
            <!-- ======================= History of Medication Use ================================= -->
            <entry invertable="true">
                <frompath>/component/section[templateId/@root="1.3.6.1.4.1.12559.11.10.1.3.1.2.3"]</frompath>
                <topath>/component/section[templateId/@root="2.16.840.1.113883.10.20.1.8"]</topath>
                <entry invertable="false">
                    <frompath>/text</frompath>
                    <topath>/text</topath>
                    <transformation name="translateText"/>
                </entry>
                <entry invertable="true">
                    <frompath>/entry[@typeCode="DRIV"]/substanceAdministration[templateId/@root="1.3.6.1.4.1.12559.11.10.1.3.1.3.4"]</frompath>
                    <topath>/entry[@typeCode="DRIV"]/substanceAdministration[templateId/@root="2.16.840.1.113883.10.20.22.4.16"]</topath>
                    <entry invertable="true">
                        <frompath>/templateId</frompath>
                        <topath>/templateId</topath>
                        <transformation name="changeTemplateRoots">
                            <entry fromid="1.3.6.1.4.1.12559.11.10.1.3.1.3.4"/>
                            <entry fromid="2.16.840.1.113883.10.20.1.24"/>
                            <entry toid="2.16.840.1.113883.10.20.22.4.16"/>
                        </transformation>
                    </entry>
                    <entry invertable="true">
                        <frompath>/consumable/manufacturedProduct[templateId/@root="2.16.840.1.113883.10.20.1.53"]</frompath>
                        <topath>/consumable/manufacturedProduct[templateId/@root="2.16.840.1.113883.10.20.22.4.23"]</topath>
                        <entry invertable="true">
                            <frompath>/templateId</frompath>
                            <topath>/templateId</topath>
                            <transformation name="changeTemplateRoots">
                                <entry fromid="2.16.840.1.113883.10.20.1.53"/>
                                <entry toid="2.16.840.1.113883.10.20.22.4.23"/>
                            </transformation>
                        </entry>
                        <entry invertable="true">
                            <frompath>/manufacturedMaterial/code</frompath>
                            <topath>/manufacturedMaterial/code</topath>
                            <transformation name="replaceCode">
                                <entry>
                                    <fromcode>
                                        <code nullFlavor="NA" xmlns="urn:hl7-org:v3"/>
                                    </fromcode>
                                </entry>
                            </transformation>
                            <transformation name="mapValueSetAndMove" map="ATC_RxNorm_epSOSActiveIngredient_VS">
                                <entry>
                                    <source>/manufacturedMaterial/epsos:ingredient[@classCode="ACTI"]/epsos:ingredient[@classCode="MMAT"]/epsos:code</source>
                                </entry>
                            </transformation>
                        </entry>

                    </entry>
                </entry>
            </entry>

            <!-- ======================= History of Medical Device Use ============================= -->
            <entry invertable="true">
                <frompath>/component/section[templateId/@root="2.16.840.1.113883.10.20.1.7"]</frompath>
                <topath>/component/section[templateId/@root="2.16.840.1.113883.10.20.1.7"]</topath>
                <entry invertable="true">
                    <frompath>/text/list</frompath>
                    <topath>/text/list</topath>
                    <transformation name="replaceNode">
                        <entry insert="true">
                            <paragraph>Original Text</paragraph>
                        </entry>
                        <entry add="true">
                            <toValue>
                                <paragraph xmlns="urn:hl7-org:v3">Warning: this translation has been generated by a software component</paragraph>
                                <list xmlns="urn:hl7-org:v3">
                                    <item>Not applicable</item>
                                </list>
                                <br xmlns="urn:hl7-org:v3"/>
                            </toValue>
                        </entry>
                    </transformation>
                </entry>
            </entry>
            <!-- ======================= Social History ============================================ -->
            <entry invertable="true">
                <frompath>/component/section[templateId/@root="2.16.840.1.113883.10.20.1.15"]</frompath>
                <topath>/component/section[templateId/@root="2.16.840.1.113883.10.20.22.2.17"]</topath>
                <entry invertable="true">
                    <frompath>/templateId</frompath>
                    <topath>/templateId</topath>
                    <transformation name="changeTemplateRoots">
                        <entry fromid="2.16.840.1.113883.10.20.1.15"/>
                        <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.3.16"/>
                        <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.3.16.1"/>
                        <entry toid="2.16.840.1.113883.10.20.22.2.17"/>
                    </transformation>
                </entry>
                <entry invertable="true">
                    <frompath>/text</frompath>
                    <topath>/text</topath>
                    <transformation name="translateText"/>
                </entry>
                <entry invertable="true">
                    <frompath>/entry[@typeCode="DRIV"]/observation[@classCode="OBS"]/[templateId/@root="1.3.6.1.4.1.19376.1.5.3.1.4.13"]</frompath>
                    <topath>/entry[@typeCode="DRIV"]/observation[@classCode="OBS"]/[templateId/@root="2.16.840.1.113883.10.20.22.4.38"]</topath>
                    <entry invertable="true">
                        <frompath>/templateId</frompath>
                        <topath>/templateId</topath>
                        <transformation name="changeTemplateRoots">
                            <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.4.13"/>
                            <entry fromid="2.16.840.1.113883.10.20.1.33"/>
                            <entry fromid="1.3.6.1.4.1.19376.1.5.3.1.4.13.4"/>
                            <entry toid="2.16.840.1.113883.10.20.22.4.38"/>
                        </transformation>
                    </entry>
                </entry>
            </entry>
            <!-- ======================= Mandatory results section ================================= -->
            <entry invertable="true">
                <frompath>none</frompath>
                <topath>/component/section[templateId[@root="2.16.840.1.113883.10.20.22.2.3"]</topath>
                <transformation name="replaceNode">
                    <entry match="false">
                        <tovalue>
                            <component xmlns="urn:hl7-org:v3">
                                <section nullFlavor="NI">
                                    <templateId root="2.16.840.1.113883.10.20.22.2.3"/>
                                    <templateId root="2.16.840.1.113883.10.20.22.2.3.1"/>
                                    <code code="30954-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="RESULTS"/>
                                    <title>Results</title>
                                    <text>
                                        <paragraph>Warning: this section has been generated by a software component</paragraph>
                                        <list>
                                            <item>No information</item>
                                        </list>
                                    </text>
                                </section>
                            </component>
                        </tovalue>
                    </entry>
                </transformation>
            </entry>
        </entry>
    </entry>
</map>
